import re
import pandas as pd
import chardet
import os
import csv

# Initialize a list to store data from all files
all_data = []

# List of file names
file_list = ['mem1.txt', 'mem2.txt', 'mem3.txt', 'mem4.txt', 'mem5.txt', 'mem6.txt', 'mem7.txt', 'mem8.txt', 'mem9.txt', 'mem10.txt',
	     'mem11.txt', 'mem12.txt', 'mem13.txt', 'mem14.txt', 'mem15.txt', 'mem16.txt', 'mem17.txt', 'mem18.txt', 'mem19.txt', 'mem20.txt']

for file_name in file_list:
    # Detect the encoding of the file
    with open(file_name, 'rb') as file:
        raw_data = file.read()
        result = chardet.detect(raw_data)
        encoding = result['encoding']

    # Open the file with the detected encoding
    with open(file_name, 'r', encoding=encoding, errors='ignore') as file:
        content = file.read()

    # Regular expression to match the lines of interest
    pattern = re.compile(r'(Native Heap|Dalvik Heap|Dalvik Other|Stack|Ashmem|Other dev|\.so mmap|\.apk mmap|\.ttf mmap|\.dex mmap|\.oat mmap|\.art mmap|Other mmap|Unknown|TOTAL)\s+'r'(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s*(\d*)\s*(\d*)\s*(\d*)')

    # Find all matches in the file content
    matches = pattern.findall(content)
    
    # Dictionary to hold data for this file
    csv_data = {}

    # Extract the data and handle missing values
    for entry in matches:
        name, pss, private_dirty, private_clean, swap_pss, heap_size, heap_alloc, heap_free = entry
        key_prefix = name.replace(" ", "").replace(".", "")
        csv_data[f'{key_prefix}_Pss'] = int(pss)
        csv_data[f'{key_prefix}_Private_Dirty'] = int(private_dirty)
        csv_data[f'{key_prefix}_Private_Clean'] = int(private_clean)
        csv_data[f'{key_prefix}_Swap_Pss'] = int(swap_pss)
        csv_data[f'{key_prefix}_Heap_Size'] = int(heap_size) if heap_size else 0
        csv_data[f'{key_prefix}_Heap_Alloc'] = int(heap_alloc) if heap_alloc else 0
        csv_data[f'{key_prefix}_Heap_Free'] = int(heap_free) if heap_free else 0
    
    # Append the data for this file to the list
    all_data.append(csv_data)

# Convert the list of dictionaries to a DataFrame
all_data_df = pd.DataFrame(all_data)
# Tạo một danh sách nhãn mới
labels = ['1' if i < 10 else '0' for i in range(len(all_data_df))]

# Thêm cột nhãn vào DataFrame
all_data_df['Label'] = labels

# Save the combined data to a CSV file
csv_filename = 'combined_feature_mem.csv'
all_data_df.to_csv(csv_filename, index=False)

print(f'Data written to {csv_filename}')
