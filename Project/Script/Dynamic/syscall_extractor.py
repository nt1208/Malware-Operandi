import re
import pandas as pd
import chardet
import os
import csv


all_data = []
# List of file names
file_list = ['systemcall_1.csv', 'systemcall_2.csv', 'systemcall_3.csv', 'systemcall_4.csv', 'systemcall_5.csv',
'systemcall_6.csv', 'systemcall_7.csv', 'systemcall_8.csv', 'systemcall_9.csv', 'systemcall_10.csv',
'systemcall_11.csv', 'systemcall_12.csv', 'systemcall_13.csv', 'systemcall_14.csv', 'systemcall_15.csv',
'systemcall_16.csv', 'systemcall_17.csv', 'systemcall_18.csv', 'systemcall_19.csv', 'systemcall_20.csv']

for file_name in file_list:
    # Detect the encoding of the file
    with open(file_name, 'rb') as file:
        raw_data = file.read()
        result = chardet.detect(raw_data)
        encoding = result['encoding']

    # Open the file with the detected encoding
    with open(file_name, 'r', encoding=encoding, errors='ignore') as file:
        content = file.read()
        content = '\n'.join(line for line in content.split('\n') if not all(char == '-' or char.isspace() for char in line))
    print(content)

    pattern = r'(\d+(?:\.\d+)?)\s+(\d+(?:\.\d+)?)\s+(\d+)\s+(\d+)\s+(\d*)\s*(\S+)'

    matches = re.findall(pattern, content)
    print(matches)
    csv_data = {}


    # Extract the data and handle missing values
    for entry in matches:
        time, seconds, usecs_call, calls, errors, name = entry
        key_prefix = name.replace(" ", "").replace(".", "")
        csv_data[f'{key_prefix}_time'] = float(time)
        csv_data[f'{key_prefix}_seconds'] = float(seconds)
        csv_data[f'{key_prefix}_usecs_call'] = float(usecs_call)
        csv_data[f'{key_prefix}_calls'] = float(calls)
        csv_data[f'{key_prefix}_error'] = float(errors) if errors else 0
        

    all_data.append(csv_data)

# Convert the list of dictionaries to a DataFrame
all_data_df = pd.DataFrame(all_data)
# Tạo một danh sách nhãn mới
labels = ['1' if i < 10 else '0' for i in range(len(all_data_df))]

# Thêm cột nhãn vào DataFrame
all_data_df['Label'] = labels

# Save the combined data to a CSV file
csv_filename = 'combined_feature_sys.csv'
all_data_df.to_csv(csv_filename, index=False)

print(f'Data written to {csv_filename}')
