import numpy as np
import re
import csv

# Hàm đọc danh sách quyền từ tệp APK
#def read_permissions_from_apk(file_path):
    #with open(file_path, "r", encoding="utf-8") as file:
        #content = file.read()
        #permissions = re.findall(r"android\.permission\.\w+", content)  # Sử dụng regex để tìm các quyền
    #return permissions

# Hàm tạo vector nhị phân từ danh sách quyền của mỗi ứng dụng
def create_binary_permission_vector(permissions, unique_permissions, is_ransomware):
    num_unique_permissions = len(unique_permissions)
    binary_vector = np.zeros(num_unique_permissions + 1, dtSype=int)  # Tạo vector nhị phân với thêm một bit cuối cùng
    for perm in permissions:
        if perm in unique_permissions:
            index = unique_permissions.index(perm)  # Xác định chỉ mục của quyền trong danh sách duy nhất
            binary_vector[index] = 1  # Đánh dấu 1 cho quyền này trong vector
    binary_vector[-1] = 1 if is_ransomware else 0  # Đặt bit cuối cùng thành 1 nếu là ransomware, ngược lại là 0
    return binary_vector

# Đọc danh sách quyền từ tệp permission_results.txt cho ransomware
with open("rans_permission_results.txt", "r", encoding="utf-8") as file:
    ransomware_permission_lines = file.readlines()

# Đọc danh sách quyền từ tệp permission_results.txt cho non-ransomware
with open("feature_per.txt", "r", encoding="utf-8") as file:
    non_ransomware_permission_lines = file.readlines()

# Tiền xử lý dữ liệu để loại bỏ các quyền trùng lặp và tạo danh sách các quyền duy nhất
all_permissions = []
for line in ransomware_permission_lines:
    permissions = re.findall(r"android\.permission\.\w+", line)  # Sử dụng regex để tìm các quyền
    all_permissions.extend(permissions)

for line in non_ransomware_permission_lines:
    permissions = re.findall(r"android\.permission\.\w+", line)  # Sử dụng regex để tìm các quyền
    all_permissions.extend(permissions)

unique_permissions = list(set(all_permissions))
num_unique_permissions = len(unique_permissions)

# Tạo danh sách các vector nhị phân cho ransomware
ransomware_vectors = []
for line in ransomware_permission_lines:
    permissions = re.findall(r"android\.permission\.\w+", line)  # Sử dụng regex để tìm các quyền
    binary_permission_vector = create_binary_permission_vector(permissions, unique_permissions, True)
    ransomware_vectors.append(binary_permission_vector)

# Tạo danh sách các vector nhị phân cho non-ransomware
non_ransomware_vectors = []
for line in non_ransomware_permission_lines:
    permissions = re.findall(r"android\.permission\.\w+", line)  # Sử dụng regex để tìm các quyền
    binary_permission_vector = create_binary_permission_vector(permissions, unique_permissions, False)
    non_ransomware_vectors.append(binary_permission_vector)

# Kết hợp các vector thành một tập dữ liệu
all_vectors = ransomware_vectors + non_ransomware_vectors

# Chuyển danh sách các vector nhị phân sang ma trận
binary_permission_matrix = np.array(all_vectors)

# In ra danh sách các vector nhị phân
print("Number of Unique Permissions:", num_unique_permissions)
print("Unique Permission Names:")
for permission in unique_permissions:
    print(permission)

print("Binary Permission Vectors:", binary_permission_matrix.shape)
for vector in all_vectors:
    print(vector)

# Xuất dữ liệu ra file CSV
with open('permission_vectors.csv', 'w', newline='') as csvfile:
    writer = csv.writer(csvfile)
    writer.writerow(unique_permissions + ['Label'])
    writer.writerows(binary_permission_matrix)

